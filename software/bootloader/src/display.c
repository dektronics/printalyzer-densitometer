#include "display.h"

#include <string.h>

#include "stm32l0xx_hal.h"
#include "board_config.h"

#ifdef HAL_SPI_MODULE_ENABLED

extern SPI_HandleTypeDef hspi1;

static void display_write_page(uint8_t page_id, uint8_t offset, const uint8_t *data, uint8_t len);

static const uint8_t init_sequence[] = {
    0xAE,       /* display off */
    0xD5, 0xF0, /* Div=0, Fosc=16 */
    0xA8, 0x3F, /* multiplex ratio */
    0xD3, 0x00, /* display offset */
    0x40,       /* set display start line to 0 */
    0x8D, 0x14, /* [2] charge pump setting (p62): 0x014 enable, 0x010 disable, SSD1306 only, should be removed for SH1106 */
    0x20, 0x00, /* horizontal addressing mode */
    0xA1,       /* segment remap a0/a1*/
    0xC8,       /* c0: scan dir normal, c8: reverse */
    0xDA, 0x12, /* com pin HW config, sequential com pin config (bit 4), disable left/right remap (bit 5) */
    0x81, 0xCF, /* [2] set contrast control */
    0xD9, 0xF1, /* [2] pre-charge period 0x022/f1*/
    0xDB, 0x40, /* vcomh deselect level */
    0x2E,       /* Deactivate scroll */
    0xA4,       /* output ram to display */
    0xA6        /* none inverted normal display mode */
};

void display_init()
{
    /* Display reset */
    HAL_GPIO_WritePin(DISP_RES_GPIO_Port, DISP_RES_Pin, GPIO_PIN_SET);
    HAL_Delay(1);
    HAL_GPIO_WritePin(DISP_RES_GPIO_Port, DISP_RES_Pin, GPIO_PIN_RESET);
    HAL_Delay(10);
    HAL_GPIO_WritePin(DISP_RES_GPIO_Port, DISP_RES_Pin, GPIO_PIN_SET);

    /* Write init command sequence */
    HAL_GPIO_WritePin(DISP_CS_GPIO_Port, DISP_CS_Pin, GPIO_PIN_RESET);
    HAL_SPI_Transmit(&hspi1, (uint8_t *)init_sequence, sizeof(init_sequence), HAL_MAX_DELAY);
    HAL_GPIO_WritePin(DISP_CS_GPIO_Port, DISP_CS_Pin, GPIO_PIN_SET);
}

void display_enable()
{
    uint8_t buf[1];

    /* Display on */
    HAL_GPIO_WritePin(DISP_CS_GPIO_Port, DISP_CS_Pin, GPIO_PIN_RESET);
    buf[0] = 0xAF;
    HAL_SPI_Transmit(&hspi1, buf, 1, HAL_MAX_DELAY);
    HAL_GPIO_WritePin(DISP_CS_GPIO_Port, DISP_CS_Pin, GPIO_PIN_SET);
}

void display_write_page(uint8_t page_id, uint8_t offset, const uint8_t *data, uint8_t len)
{
    uint8_t buf[128] = { 0x40, 0x10, 0x00, 0xB0 };
    buf[3] += page_id;

    HAL_GPIO_WritePin(DISP_CS_GPIO_Port, DISP_CS_Pin, GPIO_PIN_RESET);

    HAL_GPIO_WritePin(DISP_DC_GPIO_Port, DISP_DC_Pin, GPIO_PIN_RESET);
    HAL_SPI_Transmit(&hspi1, buf, 4, HAL_MAX_DELAY);

    buf[0] = 0x00; buf[1] = 0x00; buf[2] = 0x00; buf[3] = 0x00;
    if (data) {
        memcpy(buf + offset, data, len);
    }

    HAL_GPIO_WritePin(DISP_DC_GPIO_Port, DISP_DC_Pin, GPIO_PIN_SET);
    HAL_SPI_Transmit(&hspi1, (uint8_t *)buf, sizeof(buf), HAL_MAX_DELAY);

    HAL_GPIO_WritePin(DISP_CS_GPIO_Port, DISP_CS_Pin, GPIO_PIN_SET);
}

static const uint8_t usb_page_2_offset = 45;
static const uint8_t usb_page_2[] = {
    0xFC, 0xFC, 0xFC,
    0xFC, 0xFC, 0xFC, 0xFC, 0x70, 0x70, 0x70, 0x70,
    0x70, 0x70, 0x60, 0xE0, 0xE0, 0xC0, 0x80
};

static const uint8_t usb_page_3_offset = 33;
static const uint8_t usb_page_3[] = {
    0x80, 0x80, 0xC0, 0xE0, 0xE0, 0xF0, 0x80,
    0x80, 0x80, 0x80, 0x80, 0x80, 0x81, 0x81, 0x81,
    0x81, 0x81, 0x81, 0x81, 0x80, 0x80, 0x80, 0x80,
    0x80, 0x80, 0x80, 0x80, 0x81, 0x83, 0x87, 0x8F,
    0x9E, 0xBC, 0xF8, 0xF0, 0xE0, 0xC0, 0x80, 0x80,
    0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
    0x80, 0x80, 0x80, 0x80, 0xC0, 0xF0, 0xF8, 0xF8,
    0xFC, 0xFC, 0xFC, 0xFC, 0xF8, 0xF8, 0xF0, 0xC0
};

static const uint8_t usb_page_4_offset = 33;
static const uint8_t usb_page_4[] = {
    0x01, 0x01, 0x03, 0x07, 0x07, 0x0F, 0x01,
    0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01,
    0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x81,
    0x81, 0x81, 0x81, 0x01, 0x01, 0x01, 0x01, 0x01,
    0x01, 0x01, 0x01, 0x01, 0x01, 0x81, 0xC1, 0xE1,
    0xF1, 0x79, 0x3D, 0x1F, 0x07, 0x03, 0x03, 0x01,
    0x01, 0x01, 0x01, 0x01, 0x03, 0x0F, 0x1F, 0x1F,
    0x3F, 0x3F, 0x3F, 0x3F, 0x1F, 0x1F, 0x0F, 0x03
};

static const uint8_t usb_page_5_offset = 53;
static const uint8_t usb_page_5[] = {
    0x0E, 0x1F, 0x3F,
    0x3F, 0x3F, 0x3F, 0x1F, 0x0E, 0x0E, 0x0E, 0x0E,
    0x0E, 0x0E, 0x0E, 0x06, 0x07, 0x03, 0x03, 0x01
};

void display_show_usb_logo()
{
    display_write_page(0, 0, NULL, 0);
    display_write_page(1, 0, NULL, 0);
    display_write_page(2, usb_page_2_offset, usb_page_2, sizeof(usb_page_2));
    display_write_page(3, usb_page_3_offset, usb_page_3, sizeof(usb_page_3));
    display_write_page(4, usb_page_4_offset, usb_page_4, sizeof(usb_page_4));
    display_write_page(5, usb_page_5_offset, usb_page_5, sizeof(usb_page_5));
    display_write_page(6, 0, NULL, 0);
    display_write_page(7, 0, NULL, 0);
}

static const uint8_t update_page_1_offset = 57;
static const uint8_t update_page_1[] = {
    0x80, 0x80, 0x80, 0xC0, 0xC0, 0xC0, 0xC0,
    0xC0, 0xC0, 0xC0, 0xC0, 0x80, 0x80, 0x80
};

static const uint8_t update_page_2_offset = 48;
static const uint8_t update_page_2[] = {
    0x80, 0xE0, 0xF0, 0xF8, 0xFC, 0x7E, 0x3E, 0x1F,
    0x0F, 0x0F, 0x07, 0x07, 0x03, 0x03, 0x03, 0x03,
    0x03, 0x03, 0x03, 0x03, 0x07, 0x07, 0x0F, 0x0F,
    0x1F, 0x3E, 0x7E, 0xFC, 0xF8, 0xF0, 0xE0, 0x80
};

static const uint8_t update_page_3_offset = 46;
static const uint8_t update_page_3[] = {
    0xF0, 0xFE,
    0xFF, 0xFF, 0x0F, 0x03, 0x00, 0x00, 0x00, 0x00,
    0x0E, 0x0E, 0x1C, 0x1C, 0x38, 0x78, 0x70, 0xE0,
    0xE0, 0xC0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x03, 0x1F, 0xFF, 0xFF,
    0xFE, 0xF0
};

static const uint8_t update_page_4_offset = 46;
static const uint8_t update_page_4[] = {
    0xF0, 0xF0,
    0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0,
    0x70, 0x30, 0x10, 0x00, 0x00, 0x00, 0x00, 0xFF,
    0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0xC0, 0xF8, 0xFF, 0xFF,
    0x7F, 0x0F
};

static const uint8_t update_page_5_offset = 46;
static const uint8_t update_page_5[] = {
    0xFF, 0xFF,
    0x7F, 0x3F, 0x1F, 0x1F, 0x1F, 0x3F, 0x7D, 0x78,
    0xF8, 0xF0, 0xF0, 0xE0, 0xE0, 0xE0, 0xE0, 0xC0,
    0xC0, 0xE0, 0xE0, 0xE0, 0xE0, 0xF0, 0xF0, 0xF8,
    0xF8, 0x7C, 0x3E, 0x3F, 0x1F, 0x0F, 0x03, 0x01
};

static const uint8_t update_page_6_offset = 46;
static const uint8_t update_page_6[] = {
    0x01, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x01, 0x01, 0x01, 0x01, 0x03, 0x03,
    0x03, 0x03, 0x01, 0x01, 0x01, 0x01
};

void display_show_update_icon()
{
    display_write_page(0, 0, NULL, 0);
    display_write_page(1, update_page_1_offset, update_page_1, sizeof(update_page_1));
    display_write_page(2, update_page_2_offset, update_page_2, sizeof(update_page_2));
    display_write_page(3, update_page_3_offset, update_page_3, sizeof(update_page_3));
    display_write_page(4, update_page_4_offset, update_page_4, sizeof(update_page_4));
    display_write_page(5, update_page_5_offset, update_page_5, sizeof(update_page_5));
    display_write_page(6, update_page_6_offset, update_page_6, sizeof(update_page_6));
    display_write_page(7, 0, NULL, 0);
}

void display_show_progress(uint8_t progress)
{
    uint8_t page_buf[128] = {0};

    if (progress > 128) { progress = 128; }

    if (progress > 0) {
        memset(page_buf + (128 - progress), 0x3F, progress);
    }

    display_write_page(0, 0, page_buf, sizeof(page_buf));
}

#endif
